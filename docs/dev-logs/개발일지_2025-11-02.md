# 개발 일지 - 2025년 11월 2일

## 📋 작업 개요
- 도매상 신청 거부 기능 버그 수정
- 마이페이지 기능 구현

---

## 🐛 1. 도매상 거부 기능 버그 수정

### 문제 상황
관리자가 도매상 신청을 거부할 때 다음과 같은 에러가 발생:
- `400 Bad Request`
- `Empty or invalid json`
- `No API key found in request`
- `Could not find the rejection_reason column in the schema`

### 원인 분석

#### 1.1 JSON body 전달 문제
**파일**: `lib/services/admin.service.ts`

PATCH 요청 시 데이터를 직접 전달하지 않고 `body: JSON.stringify(...)`로 감싸야 함.

**수정 전**:
```typescript
await patch(
  `/rest/v1/${this.COLLECTION}?uid=eq.${uid}`,
  {
    verification_status: VerificationStatus.REJECTED,
    user_type: UserType.NORMAL,
    rejection_reason: rejectionReason.trim(),
    updated_at: new Date().toISOString(),
  }
);
```

**수정 후**:
```typescript
await patch(
  `/rest/v1/${this.COLLECTION}?uid=eq.${uid}`,
  {
    requireAuth: true,
    headers: {
      'Prefer': 'resolution=merge-duplicates'
    },
    body: JSON.stringify({
      verification_status: VerificationStatus.REJECTED,
      user_type: UserType.NORMAL,
      rejection_reason: rejectionReason.trim(),
      updated_at: new Date().toISOString(),
    })
  }
);
```

#### 1.2 API Key 헤더 누락 문제
**파일**: `lib/utils/fetch.ts:52-57`

헤더 병합 순서 문제로 인해 커스텀 헤더가 기본 헤더(`apikey`, `Content-Type`)를 덮어쓰는 문제 발생.

**수정 전**:
```typescript
const headers: HeadersInit = {
  'apikey': SUPABASE_ANON_KEY,
  'Content-Type': 'application/json',
  ...fetchOptions.headers,  // 위의 헤더를 덮어씀
};
```

**수정 후**:
```typescript
const headers: HeadersInit = {
  ...fetchOptions.headers,  // 먼저 펼침
  'apikey': SUPABASE_ANON_KEY,
  'Content-Type': 'application/json',  // 필수 헤더가 항상 보존됨
};
```

#### 1.3 데이터베이스 스키마 문제
**문제**: `users` 테이블에 `rejection_reason` 컬럼이 없음

**해결**: 기존에 작성된 마이그레이션 SQL 파일을 Supabase SQL Editor에서 실행 필요

**파일**: `supabase-add-rejection-reason.sql`
```sql
-- users 테이블에 rejection_reason 컬럼 추가
ALTER TABLE public.users
ADD COLUMN IF NOT EXISTS rejection_reason TEXT;

-- 컬럼 코멘트 추가
COMMENT ON COLUMN public.users.rejection_reason IS '도매상 승인 거절 사유. 관리자가 도매상 신청을 거절할 때 입력하는 사유. 사용자가 확인하고 재신청 가능.';
```

### 수정된 파일 목록
1. `lib/services/admin.service.ts` (67-80줄, 103-117줄)
2. `lib/utils/fetch.ts` (52-57줄)

---

## ✨ 2. 마이페이지 기능 구현

### 구현 내용

#### 2.1 헤더에 마이페이지 링크 추가
**파일**: `components/layout/header.tsx:141-155`

로그인한 사용자에게 "마이페이지" 링크 표시:
```tsx
<div className="flex items-center gap-3 border-l pl-6">
  <span className="text-sm text-gray-600">{user.name}님</span>
  <Link href="/mypage" className="text-sm text-gray-600 hover:text-gray-900 transition">
    마이페이지
  </Link>
  <button onClick={handleLogout} className="text-sm text-gray-600 hover:text-gray-900 transition">
    로그아웃
  </button>
</div>
```

#### 2.2 UserService 생성
**파일**: `lib/services/user.service.ts` (새 파일)

**주요 메서드**:
- `getUserByUid(uid: string)`: 사용자 정보 조회
- `updateUser(uid: string, updates: {...})`: 사용자 정보 수정 (이름, 전화번호)
- `reapplyWholesaler(uid: string, businessRegistrationUrl: string)`: 도매상 재신청

#### 2.3 마이페이지 구현
**파일**: `app/(main)/mypage/page.tsx` (새 파일)

**주요 기능**:

1. **계정 정보 확인 및 수정**
   - 이메일: 읽기 전용 (변경 불가)
   - 이름: 수정 가능
   - 전화번호: 수정 가능
   - 회원 유형: 읽기 전용
   - 가입일: 읽기 전용

2. **도매상 승인 상태 (도매상 회원만 표시)**
   - 승인 상태 뱃지 표시:
     - 🟡 승인 대기 중
     - 🟢 승인 완료
     - 🔴 승인 거부됨

3. **승인 거절 사유 표시**
   - 도매상 승인이 거부된 경우
   - 관리자가 입력한 거절 사유를 확인 가능
   - "도매상 재신청" 버튼 제공

4. **제출한 사업자 등록증 확인**
   - 도매상 회원인 경우
   - 제출한 사업자 등록증 파일 확인 가능

### UI/UX 특징
- 수정 모드 토글: 기본적으로 읽기 모드, "수정" 버튼 클릭 시 수정 모드
- 저장/취소 버튼: 수정 모드에서만 표시
- 반응형 디자인: 모바일, 태블릿, 데스크톱 대응
- 에러 핸들링: 수정 실패 시 알림 메시지 표시

### 생성된 파일 목록
1. `lib/services/user.service.ts` (새 파일)
2. `app/(main)/mypage/page.tsx` (새 파일)

### 수정된 파일 목록
1. `components/layout/header.tsx` (141-155줄)

---

## 🔄 데이터베이스 마이그레이션 필요

다음 SQL을 Supabase SQL Editor에서 실행해야 합니다:

```sql
-- users 테이블에 rejection_reason 컬럼 추가
ALTER TABLE public.users
ADD COLUMN IF NOT EXISTS rejection_reason TEXT;

-- 컬럼 코멘트 추가
COMMENT ON COLUMN public.users.rejection_reason IS '도매상 승인 거절 사유. 관리자가 도매상 신청을 거절할 때 입력하는 사유. 사용자가 확인하고 재신청 가능.';
```

---

## 📝 테스트 체크리스트

### 도매상 거부 기능
- [ ] 관리자 계정으로 로그인
- [ ] 관리자 대시보드 접속
- [ ] 도매상 신청 대기 중인 회원 확인
- [ ] "거부" 버튼 클릭
- [ ] 거부 사유 입력
- [ ] "거부하기" 버튼 클릭
- [ ] 정상적으로 거부 처리되는지 확인
- [ ] 거부된 회원이 목록에서 사라지는지 확인

### 마이페이지 기능
- [ ] 일반 회원으로 로그인
- [ ] 헤더에 "마이페이지" 링크 표시 확인
- [ ] 마이페이지 접속
- [ ] 계정 정보 확인
- [ ] "수정" 버튼 클릭
- [ ] 이름, 전화번호 수정
- [ ] "저장" 버튼 클릭
- [ ] 수정 내용 반영 확인
- [ ] "취소" 버튼 동작 확인

### 도매상 거절 사유 확인
- [ ] 거부된 도매상 회원으로 로그인
- [ ] 마이페이지 접속
- [ ] 도매상 승인 상태 섹션 확인
- [ ] 거절 사유 표시 확인
- [ ] "도매상 재신청" 버튼 확인

---

## 🚀 다음 개발 예정 사항

1. 도매상 재신청 페이지 구현
2. 비밀번호 변경 기능 추가
3. 프로필 이미지 업로드 기능
4. 회원 탈퇴 기능
5. 마이페이지에서 주문 내역 확인 기능
6. 마이페이지에서 찜한 상품 목록 확인 기능

---

## 💡 참고 사항

### 기술 스택
- **Frontend**: Next.js 14 (App Router), TypeScript, Tailwind CSS
- **Backend**: Supabase (PostgreSQL, Auth, Storage)
- **State Management**: Zustand

### 코드 컨벤션
- 파일명: kebab-case (예: `user.service.ts`)
- 컴포넌트: PascalCase (예: `MyPage`)
- 함수/변수: camelCase (예: `getUserByUid`)
- 상수: SCREAMING_SNAKE_CASE (예: `SUPABASE_URL`)

### 디렉토리 구조
```
app/(main)/
  ├── mypage/
  │   └── page.tsx          # 마이페이지
lib/
  ├── services/
  │   ├── admin.service.ts  # 관리자 서비스
  │   └── user.service.ts   # 사용자 서비스 (신규)
  └── utils/
      └── fetch.ts          # Fetch API 유틸리티 (수정)
components/
  └── layout/
      └── header.tsx        # 헤더 컴포넌트 (수정)
```

---

## 📌 주요 이슈 및 해결

### Issue #1: PATCH 요청 실패
- **원인**: body를 JSON.stringify로 감싸지 않음
- **해결**: `body: JSON.stringify({...})` 형태로 수정

### Issue #2: API key 누락
- **원인**: 헤더 병합 순서 문제
- **해결**: 커스텀 헤더를 먼저 펼치고, 기본 헤더를 나중에 설정

### Issue #3: rejection_reason 컬럼 없음
- **원인**: 데이터베이스 마이그레이션 미실행
- **해결**: SQL 마이그레이션 파일 실행 필요

---

## ✅ 완료된 작업

- [x] 도매상 거부 기능 버그 수정
  - [x] JSON body 전달 문제 수정
  - [x] API key 헤더 누락 문제 수정
  - [x] requireAuth 옵션 추가
  - [x] Prefer 헤더 추가
- [x] 마이페이지 기능 구현
  - [x] 헤더에 마이페이지 링크 추가
  - [x] UserService 생성
  - [x] 마이페이지 UI 구현
  - [x] 계정 정보 수정 기능
  - [x] 도매상 승인 상태 표시
  - [x] 거절 사유 표시 기능
  - [x] 사업자 등록증 확인 기능

---

**작성일**: 2025년 11월 2일
**작성자**: Claude Code
**개발 환경**: Windows, Node.js, Next.js 14, Supabase
